# Tavern test cases for the System Configuration Service (SCSD) creds API
# and Redfish Account Service password
# Author: Mitch Schooler
# Service: System Configuration Service

# HMS test metrics test cases: 7
# 1. GET HSM /State/Components compute node API response code
# 2. GET HSM /State/Components compute node API response body
# 3. GET /{xname}/redfish/v1/AccountService API default password response code
# 4. Disabled (BMC Lockout Issues CASMHMS-3447/CASMHMS-3448) - GET /{xname}/redfish/v1/AccountService API incorrect password response code
# 5. POST SCSD /bmc/creds/{xname} API new password response code
# 6. Disabled (BMC Lockout Issues CASMHMS-3447/CASMHMS-3448) - GET /{xname}/redfish/v1/AccountService API original password response code
# 7. GET /{xname}/redfish/v1/AccountService API new password response code
# 8. POST SCSD /bmc/creds/{xname} API restore original password response code
# 9. GET /{xname}/redfish/v1/AccountService API original password response code
# 10. Disabled (BMC Lockout Issues CASMHMS-3447/CASMHMS-3448) - GET /{xname}/redfish/v1/AccountService API incorrect password response code
---
test_name: Ensure that we can update the Redfish Service Account password for compute node BMCs

stages:
  # 1. GET HSM /State/Components compute node API response code
  # 2. GET HSM /State/Components compute node API response body
  - name: Get a compute NodeBMC xname from the HSM Components collection to use in the following stages
    request:
      url: "{base_url}/smd/hsm/v1/State/Components?type=Node&role=Compute&state=Ready"
      method: GET
      headers:
        Authorization: "Bearer {access_token}"
      verify: !bool "{verify}"
    response:
      status_code: 200
      save:
        $ext:
          # convert the compute node xname to its BMC's xname (example: x3000c0s7b0n0 -> x3000c0s7b0)
          function: hms_ct_test_lib_ncn-resources_remote-resources:get_bmc_xname_from_first_node_xname
        body:
          xname: Components

  # 3. GET /{xname}/redfish/v1/AccountService API default password response code
  - name: Verify the Redfish Account Service for the compute NodeBMC can be accessed with the default password
    request:
      url: "https://{xname}/redfish/v1/AccountService"
      method: GET
      headers:
        # Authorization: "Basic $(echo -n user:password | base64)"
        Authorization: "Basic {bmc_basic_auth_orig}"
      # needed for BMC Redfish communication
      verify: False
    response:
      status_code: 200

  ## 4. Disabled (BMC Lockout Issues CASMHMS-3447/CASMHMS-3448) - GET /{xname}/redfish/v1/AccountService API incorrect password response code
  #- name: Verify the Redfish Account Service for the compute NodeBMC cannot be accessed with an incorrect password
  #  request:
  #    url: "https://{xname}/redfish/v1/AccountService"
  #    method: GET
  #    headers:
  #      # Authorization: "Basic $(echo -n user:password | base64)"
  #      Authorization: "Basic {bmc_basic_auth_new}"
  #    # needed for BMC Redfish communication
  #    verify: False
  #  response:
  #    status_code: 401

  # 5. POST SCSD /bmc/creds/{xname} API new password response code
  - name: Verify that we can set a new Redfish Account Service password for the compute NodeBMC using SCSD
    request:
      url: "{base_url}/scsd/v1/bmc/creds/{xname}"
      json: {"Force":false,"Creds":{"Username":"root","Password":"{bmc_password_new}"}}
      method: POST
      headers:
        Authorization: "Bearer {access_token}"
      verify: !bool "{verify}"
    response:
      status_code: 200

  ## 6. Disabled (BMC Lockout Issues CASMHMS-3447/CASMHMS-3448) - GET /{xname}/redfish/v1/AccountService API original password response code
  #- name: Verify the Redfish Account Service for the compute NodeBMC can no longer be accessed with the original password
  #  request:
  #    url: "https://{xname}/redfish/v1/AccountService"
  #    method: GET
  #    headers:
  #      # Authorization: "Basic $(echo -n user:password | base64)"
  #      Authorization: "Basic {bmc_basic_auth_orig}"
  #    # needed for BMC Redfish communication
  #    verify: False
  #  response:
  #    status_code: 401

  # 7. GET /{xname}/redfish/v1/AccountService API new password response code
  - name: Verify the Redfish Account Service for the compute NodeBMC can be accessed with the new password
    request:
      url: "https://{xname}/redfish/v1/AccountService"
      method: GET
      headers:
        # Authorization: "Basic $(echo -n user:password | base64)"
        Authorization: "Basic {bmc_basic_auth_new}"
      # needed for BMC Redfish communication
      verify: False
    response:
      status_code: 200

  # 8. POST SCSD /bmc/creds/{xname} API restore original password response code
  - name: Verify that we can restore the original Redfish Account Service password for the compute NodeBMC using SCSD
    request:
      url: "{base_url}/scsd/v1/bmc/creds/{xname}"
      json: {"Force":false,"Creds":{"Username":"root","Password":"{bmc_password_orig}"}}
      method: POST
      headers:
        Authorization: "Bearer {access_token}"
      verify: !bool "{verify}"
    response:
      status_code: 200

  # 9. GET /{xname}/redfish/v1/AccountService API original password response code
  - name: Verify the Redfish Account Service for the compute NodeBMC can be accessed with the original password again
    request:
      url: "https://{xname}/redfish/v1/AccountService"
      method: GET
      headers:
        # Authorization: "Basic $(echo -n user:password | base64)"
        Authorization: "Basic {bmc_basic_auth_orig}"
      # needed for BMC Redfish communication
      verify: False
    response:
      status_code: 200

  ## 10. Disabled (BMC Lockout Issues CASMHMS-3447/CASMHMS-3448) - GET /{xname}/redfish/v1/AccountService API incorrect password response code
  #- name: Verify the Redfish Account Service for the compute NodeBMC can no longer be accessed with the previously set password
  #  request:
  #    url: "https://{xname}/redfish/v1/AccountService"
  #    method: GET
  #    headers:
  #      # Authorization: "Basic $(echo -n user:password | base64)"
  #      Authorization: "Basic {bmc_basic_auth_new}"
  #    # needed for BMC Redfish communication
  #    verify: False
  #  response:
  #    status_code: 401
