# Copyright 2020 Hewlett Packard Enterprise Development LP

# Tavern test cases for BMC Redfish Account Service passwords
# Author: Mitch Schooler
# Service: System Configuration Service

# HMS test metrics test cases: 3
# 1. GET HSM /State/Components compute node API response code
# 2. GET HSM /State/Components compute node API response body
# 3. GET /{xname}/redfish/v1/AccountService API default password response code
---
test_name: Ensure that the default Redfish Service Account password is configured for node BMCs

stages:
  # 1. GET HSM /State/Components compute node API response code
  # 2. GET HSM /State/Components compute node API response body
  - name: Get a compute NodeBMC xname from the HSM Components collection to use in the following stages
    request:
      url: "{base_url}/smd/hsm/v1/State/Components?type=Node&role=Compute&state=Ready"
      method: GET
      headers:
        Authorization: "Bearer {access_token}"
      verify: !bool "{verify}"
    response:
      status_code: 200
      save:
        $ext:
          # convert the compute node xname to its BMC's xname (example: x3000c0s7b0n0 -> x3000c0s7b0)
          function: hms_ct_test_lib_ncn-resources_remote-resources:get_bmc_xname_from_first_node_xname
        body:
          xname: Components

  # 3. GET /{xname}/redfish/v1/AccountService API default password response code
  - name: Verify the Redfish Account Service for the compute NodeBMC can be accessed with the default password
    request:
      url: "https://{xname}/redfish/v1/AccountService"
      method: GET
      headers:
        # Authorization: "Basic $(echo -n user:password | base64)"
        Authorization: "Basic {bmc_basic_auth_orig}"
      # needed for BMC Redfish communication
      verify: False
    response:
      status_code: 200
